name: Build BindCraft Container

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h
    
    - name: Setup Singularity
      uses: eWaterCycle/setup-singularity@v7
      with:
        singularity-version: 3.8.3
    
    - name: Create definition file
      run: |
        cat > bindcraft.def << 'EOF'
        Bootstrap: docker
        From: nvidia/cuda:12.9.1-cudnn-runtime-ubuntu22.04
        
        %post
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y \
                python3 python3-pip git wget \
                libgfortran5 libgomp1 \
                ca-certificates && \
                rm -rf /var/lib/apt/lists/*
            
            python3 -m pip install --upgrade pip
            
            pip install --no-cache-dir \
                jax==0.4.35 jaxlib==0.4.35 \
                numpy==2.0.1 scipy==1.15.3 \
                pandas matplotlib biopython \
                git+https://github.com/sokrypton/ColabDesign.git \
                pyrosetta-installer pdbfixer
            
            git clone https://github.com/martinpacesa/BindCraft /BindCraft
            chmod +x /BindCraft/functions/dssp /BindCraft/functions/DAlphaBall.gcc
            
            mkdir -p /BindCraft/params
        
        %environment
            export PYTHONPATH=/BindCraft:$PYTHONPATH
        
        %runscript
            if [ ! -f /BindCraft/params/done.txt ]; then
                echo "Downloading AlphaFold parameters..."
                cd /BindCraft/params
                wget -q --tries=3 https://storage.googleapis.com/alphafold/alphafold_params_2022-12-06.tar
                tar -xf alphafold_params_2022-12-06.tar
                rm alphafold_params_2022-12-06.tar
                touch done.txt
            fi
            exec python3 /BindCraft/bindcraft.py "$@"
        EOF
    
    - name: Build container
      run: |
        echo "Building container..."
        singularity build --fakeroot bindcraft.sif bindcraft.def
    
    - name: Test container
      run: |
        singularity exec bindcraft.sif python3 -c "print('Container works!')"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: bindcraft-container
        path: bindcraft.sif
        retention-days: 30
